{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ card.title }}{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="fw-bold mb-1">{{ card.title }}</h3>
      {% if card.categories.exists %}
      <div class="d-flex flex-wrap gap-1">
        {% for cat in card.categories.all %}
          <span class="badge rounded-pill bg-secondary">{{ cat.name }}</span>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    <a href="{% url 'task_list' %}" class="btn btn-outline-secondary btn-sm">‚¨Ö –ù–∞–∑–∞–¥</a>
  </div>

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Ä—Ç–æ—á–∫–µ -->
  {% if card.description %}
  <p class="text-muted mb-3">{{ card.description }}</p>
  {% endif %}

  <div class="small text-muted mb-3">
    üìÖ {{ card.start_date|date:"d.m.Y" }} ‚Äî {{ card.end_date|date:"d.m.Y" }}<br>
    üè¢ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–¥–µ–ª: {{ card.responsible_department.name }}<br>
    üë§ –°–æ–∑–¥–∞–Ω–æ: {{ card.created_by.user.get_full_name|default:card.created_by.user.username }}
  </div>

  {% if card.plan_file %}
  <!-- üîπ –°—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∞ –∏ –∫–Ω–æ–ø–∫–∞ -->
    <div class="mb-3">
      <strong>–°—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∞:</strong>
      <span class="badge
        {% if card.plan_status == 'approved' %}bg-success
        {% elif card.plan_status == 'rejected' %}bg-danger
        {% elif card.plan_status == 'pending' %}bg-primary
        {% else %}bg-secondary{% endif %}">
        {{ card.get_plan_status_display }}
      </span>

      <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
      <button type="button" class="btn btn-outline-info btn-sm ms-2"
              data-bs-toggle="modal" data-bs-target="#approvalProgressModal">
        üßæ –•–æ–¥ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è
      </button>
    </div>
  {% endif %}

  {% if card.shared_departments.exists %}
      <p>
        <strong>–†–∞—Å—à–∞—Ä–µ–Ω–æ —Å –æ—Ç–¥–µ–ª–∞–º–∏:</strong>
        {% for d in card.shared_departments.all %}
          {{ d.name }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      </p>
  {% endif %}


  <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <span class="fw-semibold">–ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</span>
      <span>{{ progress }}%</span>
    </div>
    <div class="progress" style="height: 15px;">
      <div class="progress-bar bg-success" style="width: {{ progress }}%;"></div>
    </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
  <div class="d-flex justify-content-end mb-3">
    {% if not card.has_plan or card.plan_status == "approved" %}
      <a href="{% url 'task_create_for_card' card.id %}" class="btn btn-success">
          ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ –∫–∞—Ä—Ç–æ—á–∫—É
      </a>
    {% else %}
      <button class="btn btn-secondary" disabled
              data-bs-toggle="tooltip" title="–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞–Ω–∞">
          üö´ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –ø–ª–∞–Ω –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω!
      </button>
    {% endif %}
  </div>

  <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
  <!-- –§–∏–ª—å—Ç—Ä—ã –∑–∞–¥–∞—á -->
    <div class="btn-group mb-3" id="task-filters" role="group">
      <button data-filter="all" class="btn btn-outline-secondary {% if filter_type == 'all' %}active{% endif %}">–í—Å–µ</button>
      <button data-filter="approval" class="btn btn-outline-primary">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</button>
      <button data-filter="urgent" class="btn btn-outline-danger">–°—Ä–æ—á–Ω—ã–µ</button>
      <button data-filter="new" class="btn btn-outline-dark">–ù–æ–≤—ã–µ</button>
      <button data-filter="in_progress" class="btn btn-outline-warning">–í —Ä–∞–±–æ—Ç–µ</button>
      <button data-filter="done" class="btn btn-outline-success">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ -->
    <div id="task-list">
      {% include 'tasks/_task_list.html' %}
    </div>

    <!-- JS -->
    <script>
    document.addEventListener("DOMContentLoaded", () => {
      const filters = document.querySelectorAll("#task-filters button");
      const list = document.getElementById("task-list");

      filters.forEach(btn => {
        btn.addEventListener("click", async () => {
          const type = btn.dataset.filter;
          filters.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");

          const resp = await fetch(`?filter=${type}&ajax=1`);
          const html = await resp.text();
          list.innerHTML = html;
          history.replaceState(null, "", `?filter=${type}`);
        });
      });
    });
    </script>

</div>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —Ö–æ–¥ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è -->
<div class="modal fade" id="approvalProgressModal" tabindex="-1" aria-labelledby="approvalProgressLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="approvalProgressLabel">–•–æ–¥ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –ø–ª–∞–Ω–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">

        {% with total=card.cardapproverorder_set.count %}
        <p class="text-muted mb-3">
          –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ:
          <strong>{{ card.current_approver_index|default:0 }}</strong> –∏–∑ <strong>{{ total }}</strong>
          {% if card.final_approver %}
            (+ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)
          {% endif %}
        </p>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
        <div class="progress mb-4" style="height: 10px;">
          <div class="progress-bar
            {% if card.plan_status == 'approved' %}bg-success
            {% elif card.plan_status == 'rejected' %}bg-danger
            {% else %}bg-info{% endif %}"
            role="progressbar"
            style="width: {% widthratio card.current_approver_index total 100 %}%">
          </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Å–æ–≥–ª–∞—Å—É—é—â–∏—Ö -->
        <ul class="list-group">
          {% for rel in card.cardapproverorder_set.all %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ rel.employee.user.get_full_name|default:rel.employee.user.username }}</strong><br>
                <small class="text-muted">{{ rel.employee.position }}</small>
              </div>
              {% if forloop.counter0 < card.current_approver_index %}
                <span class="badge bg-success">‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ</span>
              {% elif forloop.counter0 == card.current_approver_index and card.plan_status == "pending" %}
                <span class="badge bg-primary">‚è≥ –¢–µ–∫—É—â–∏–π</span>
              {% else %}
                <span class="badge bg-secondary">–û–∂–∏–¥–∞–µ—Ç</span>
              {% endif %}
            </li>
          {% empty %}
            <li class="list-group-item text-muted">–°–æ–≥–ª–∞—Å—É—é—â–∏–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</li>
          {% endfor %}
        </ul>

        <!-- –§–∏–Ω–∞–ª—å–Ω—ã–π —É—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π -->
        {% if card.final_approver %}
          <div class="mt-3 border-top pt-3">
            <strong>–§–∏–Ω–∞–ª—å–Ω—ã–π —É—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π:</strong><br>
            {{ card.final_approver.user.get_full_name|default:card.final_approver.user.username }}
            {% if card.is_fully_approved %}
              <span class="badge bg-success ms-2">‚úÖ –£—Ç–≤–µ—Ä–∂–¥—ë–Ω</span>
            {% elif card.current_approver_index == total %}
              <span class="badge bg-warning text-dark ms-2">‚è≥ –û–∂–∏–¥–∞–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</span>
            {% endif %}
          </div>
        {% endif %}
        {% endwith %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
