{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ card.title }}{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="fw-bold mb-1">{{ card.title }}</h3>
      {% if card.categories.exists %}
      <div class="d-flex flex-wrap gap-1">
        {% for cat in card.categories.all %}
          <span class="badge rounded-pill bg-secondary">{{ cat.name }}</span>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    <a href="{% url 'task_list' %}" class="btn btn-outline-secondary btn-sm">‚¨Ö –ù–∞–∑–∞–¥</a>
  </div>

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Ä—Ç–æ—á–∫–µ -->
  {% if card.description %}
  <p class="text-muted mb-3">{{ card.description }}</p>
  {% endif %}

  <div class="small text-muted mb-3">
    üìÖ {{ card.start_date|date:"d.m.Y" }} ‚Äî {{ card.end_date|date:"d.m.Y" }}<br>
    üè¢ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–¥–µ–ª: {{ card.responsible_department.name }}<br>
    üë§ –°–æ–∑–¥–∞–Ω–æ: {{ card.created_by.user.get_full_name|default:card.created_by.user.username }}
  </div>

  {% if card.plan_file %}
  <!-- üîπ –°—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∞ –∏ –∫–Ω–æ–ø–∫–∞ -->
    <div class="mb-3">
      <p><strong>–§–∞–π–ª:</strong>
        <a href="{{ card.plan_file.url }}" target="_blank">üìé {{ card.plan_file.name|cut:"event_plans/" }}</a>
      </p>
      <strong>–°—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∞:</strong>
      <span class="badge
        {% if card.plan_status == 'approved' %}bg-success
        {% elif card.plan_status == 'rejected' %}bg-danger
        {% elif card.plan_status == 'pending' %}bg-primary
        {% else %}bg-secondary{% endif %}">
        {{ card.get_plan_status_display }}
      </span>

      <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
      <button type="button" class="btn btn-outline-info btn-sm ms-2"
              data-bs-toggle="modal" data-bs-target="#approvalProgressModal">
        üßæ –•–æ–¥ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è
      </button>
    </div>
  {% endif %}


    {% if card.plan_status == "rejected" and card.plan_rejected_reason and card.created_by == user.employee%}
        <hr>
        <h5 class="fw-semibold">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–æ–≤–µ—Ä—è—é—â–µ–≥–æ</h5>
        <div class="alert alert-info">{{ card.plan_rejected_reason }}</div>
    {% endif %}

    {% if card.plan_status == "rejected" and card.created_by == user.employee %}
    <form action="{% url 'send_plan_again' card.id %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <label class="form-label fw-semibold">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø–ª–∞–Ω</label>
        <input type="file" name="plan_file" class="form-control mb-2" required>

        <button class="btn btn-primary">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ</button>
    </form>
    {% endif %}



  {% if card.shared_departments.exists %}
      <p>
        <strong>–†–∞—Å—à–∞—Ä–µ–Ω–æ —Å –æ—Ç–¥–µ–ª–∞–º–∏:</strong>
        {% for d in card.shared_departments.all %}
          {{ d.name }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      </p>
  {% endif %}


    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
    <div class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-1">
        <span class="fw-semibold">–ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</span>
        <span>
          {{ card.progress.done }}/{{ card.progress.total }}
          ({{ card.progress.percent }}%)
        </span>
      </div>

      <div class="progress" style="height: 15px;">
        <div class="progress-bar bg-success"
             style="width: {{ card.progress.percent }}%;">
        </div>
      </div>
    </div>


  <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
  <div class="d-flex justify-content-end mb-3">
    {% if not card.has_plan or card.plan_status == "approved" %}
      <a href="{% url 'task_create_for_card' card.id %}" class="btn btn-success">
          ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ –∫–∞—Ä—Ç–æ—á–∫—É
      </a>
    {% else %}
      <button class="btn btn-secondary" disabled
              data-bs-toggle="tooltip" title="–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞–Ω–∞">
          üö´ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –ø–ª–∞–Ω –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω!
      </button>
    {% endif %}
  </div>

       <!-- üîπ –§–∏–ª—å—Ç—Ä—ã –ø–æ –≤–ª–∞–¥–µ–ª—å—Ü—É -->
    <div class="mb-3 d-flex flex-wrap gap-2">
      <a href="?owner=mine"
         class="category-tab {% if owner_filter == 'mine' %}active{% endif %}"
         data-color="#0d6efd">–ú–æ–∏</a>

      <a href="?owner=department"
         class="category-tab {% if owner_filter == 'department' %}active{% endif %}"
         data-color="#198754">–ú–æ–π –æ—Ç–¥–µ–ª</a>

      <a href="?owner=all"
         class="category-tab {% if owner_filter == 'all' %}active{% endif %}"
         data-color="#6c757d">–í—Å–µ</a>
    </div>


  <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
  <!-- –§–∏–ª—å—Ç—Ä—ã –∑–∞–¥–∞—á -->
    {% include "tasks/_task_list_wrapper.html" %}


    <script>
    document.addEventListener("DOMContentLoaded", () => {
      const statusFilters = document.querySelectorAll("#task-filters button");
      const ownerFilters = document.querySelectorAll(".category-tab");
      const list = document.getElementById("task-list");

      let currentOwner = "{{ owner_filter }}";
      let currentStatus = "{{ filter_type }}";

      async function updateList(owner, status) {
        const resp = await fetch(`?owner=${owner}&filter=${status}&ajax=1`);
        const html = await resp.text();
        list.innerHTML = html;

        history.replaceState(null, "", `?owner=${owner}&filter=${status}`);

        // üî• –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏
        updateCounters(owner);
      }

      async function updateCounters(owner) {
        const resp = await fetch(`?owner=${owner}&count=1`);
        const data = await resp.json();

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—ã –≤ –∫–Ω–æ–ø–∫–∞—Ö
        document.querySelector('[data-filter="all"] .badge').innerText = data.total;
        document.querySelector('[data-filter="review"] .badge').innerText = data.review;
        document.querySelector('[data-filter="urgent"] .badge').innerText = data.urgent;
        document.querySelector('[data-filter="new"] .badge').innerText = data.new;
        document.querySelector('[data-filter="in_progress"] .badge').innerText = data.in_progress;
        document.querySelector('[data-filter="done"] .badge').innerText = data.done;
      }

      // --- –ö–ª–∏–∫ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ ---
      ownerFilters.forEach(tab => {
        tab.addEventListener("click", e => {
          e.preventDefault();
          ownerFilters.forEach(t => t.classList.remove("active"));
          tab.classList.add("active");

          currentOwner = tab.getAttribute("href").split("=")[1];
          updateList(currentOwner, currentStatus);
        });
      });

      // --- –ö–ª–∏–∫ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º —Å—Ç–∞—Ç—É—Å–æ–≤ ---
      statusFilters.forEach(btn => {
        btn.addEventListener("click", e => {
          e.preventDefault();
          statusFilters.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");

          currentStatus = btn.dataset.filter;
          updateList(currentOwner, currentStatus);
        });
      });

      // üî• –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫: –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏
      updateCounters(currentOwner);
    });
    </script>




</div>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: —Ö–æ–¥ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è -->
<div class="modal fade" id="approvalProgressModal" tabindex="-1" aria-labelledby="approvalProgressLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="approvalProgressLabel">–•–æ–¥ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –ø–ª–∞–Ω–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">

        {% with total=card.cardapproverorder_set.count %}
        <p class="text-muted mb-3">
          –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ:
          <strong>{{ card.current_approver_index|default:0 }}</strong> –∏–∑ <strong>{{ total }}</strong>
          {% if card.final_approver %}
            (+ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)
          {% endif %}
        </p>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
        <div class="progress mb-4" style="height: 10px;">
          <div class="progress-bar
            {% if card.plan_status == 'approved' %}bg-success
            {% elif card.plan_status == 'rejected' %}bg-danger
            {% else %}bg-info{% endif %}"
            role="progressbar"
            style="width: {% widthratio card.current_approver_index total 100 %}%">
          </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Å–æ–≥–ª–∞—Å—É—é—â–∏—Ö -->
        <ul class="list-group">
          {% for rel in card.cardapproverorder_set.all %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ rel.employee.user.get_full_name|default:rel.employee.user.username }}</strong><br>
                <small class="text-muted">{{ rel.employee.position }}</small>
              </div>
              {% if forloop.counter0 < card.current_approver_index %}
                <span class="badge bg-success">‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ</span>
              {% elif forloop.counter0 == card.current_approver_index and card.plan_status == "pending" %}
                <span class="badge bg-primary">‚è≥ –¢–µ–∫—É—â–∏–π</span>
              {% elif forloop.counter0 == card.current_approver_index and card.plan_status == "rejected" %}
                <span class="badge bg-danger"> –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
              {% else %}
                <span class="badge bg-secondary">–û–∂–∏–¥–∞–µ—Ç</span>
              {% endif %}
            </li>
          {% empty %}
            <li class="list-group-item text-muted">–°–æ–≥–ª–∞—Å—É—é—â–∏–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</li>
          {% endfor %}
        </ul>

        <!-- –§–∏–Ω–∞–ª—å–Ω—ã–π —É—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π -->
        {% if card.final_approver %}
          <div class="mt-3 border-top pt-3">
            <strong>–§–∏–Ω–∞–ª—å–Ω—ã–π —É—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π:</strong><br>
            {{ card.final_approver.user.get_full_name|default:card.final_approver.user.username }}
            {% if card.is_fully_approved %}
              <span class="badge bg-success ms-2">‚úÖ –£—Ç–≤–µ—Ä–∂–¥—ë–Ω</span>
            {% elif card.current_approver_index == total and card.plan_status == "rejected" %}
              <span class="badge bg-danger text-dark ms-2"> –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
            {% elif card.current_approver_index == total %}
              <span class="badge bg-warning text-dark ms-2">‚è≥ –û–∂–∏–¥–∞–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</span>
            {% endif %}
          </div>
        {% endif %}
        {% endwith %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
