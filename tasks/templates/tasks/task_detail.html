{% extends "base.html" %}
{% block title %}–ó–∞–¥–∞—á–∞: {{ task.title }}{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="card shadow-sm p-4">
    <h3 class="mb-3">{{ task.title }}</h3>

    <!-- –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ -->
    <p><strong>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ:</strong>
      {% if task.card %}
        <a href="{% url 'card_detail' task.card.id %}">{{ task.card.title }}</a>
      {% else %}
        ‚Äî –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ ‚Äî
      {% endif %}
    </p>

    <!-- –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä -->
    <p><strong>–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä:</strong>
      {% if task.created_by %}
        {{ task.created_by.user.last_name }} {{ task.created_by.user.first_name }}
        {% if task.created_by.position %}
          ({{ task.created_by.position }})
        {% endif %}
      {% else %}
        ‚Äî –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî
      {% endif %}
    </p>

    <!-- –ö–æ–º—É –Ω–∞–∑–Ω–∞—á–µ–Ω–æ -->
    <p><strong>–ù–∞–∑–Ω–∞—á–µ–Ω–æ:</strong>
      {% if task.assigned_employee %}
        {{ task.assigned_employee.user.last_name }} {{ task.assigned_employee.user.first_name }}
        {% if task.assigned_employee.position %}
          ({{ task.assigned_employee.position }})
        {% endif %}
      {% elif task.assigned_department %}
        {{ task.assigned_department.name }}
      {% elif task.recipients.all %}
        {% for r in task.recipients.all %}
          {{ r.user.last_name }} {{ r.user.first_name }}
          {% if r.position %} ({{ r.position }}){% endif %}
          {% if not forloop.last %}, {% endif %}
        {% empty %}
          ‚Äî –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî
        {% endfor %}
      {% else %}
        ‚Äî –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî
      {% endif %}
    </p>

    <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> {{ task.created_at|date:"d.m.Y H:i" }}</p>

    <p><strong>–°—Ä–æ–∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è:</strong>
      {% if task.due_date %}
        {{ task.due_date|date:"d.m.Y" }}
      {% else %}
        ‚Äî –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî
      {% endif %}
    </p>

    <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
      {% if task.status == "done" %}
        ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ
      {% elif task.status == "in_progress" %}
        üü° –í —Ä–∞–±–æ—Ç–µ
      {% elif task.status == "under_review" %}
        üîµ –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
      {% elif task.status == "sent_for_review" %}
        üü£ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ  
      {% elif task.status == "new" %}
        ‚ö´ –ù–æ–≤–æ–µ
      {% elif task.status == "rejected" %}
        üî¥ –û—Ç–∫–ª–æ–Ω–µ–Ω–∞
      {% else %}
        üü§&&&
      {% endif %}
    </p>

    <hr>

    <h5>–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</h5>
    <p>{{ task.description|linebreaks }}</p>

    {% if task.google_drive_link %}
      <p><strong>Google –î–∏—Å–∫:</strong>
        <a href="{{ task.google_drive_link }}" target="_blank">
          {{ task.google_drive_link }}
        </a>
      </p>
    {% endif %}

    {% if task.review_comment %}
        <hr>
        <h5 class="fw-semibold">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–æ–≤–µ—Ä—è—é—â–µ–≥–æ</h5>
        <div class="alert alert-info">{{ task.review_comment }}</div>
    {% endif %}

    {% if task.attachment %}
      <p><strong>–§–∞–π–ª:</strong>
        <a href="{{ task.attachment.url }}" download>üìé {{ task.attachment.name }}</a>
      </p>
    {% endif %}

    <hr>

    {% if user.employee == task.assigned_employee and task.task_type == "regular" and task.status == "new" or task.status == "rejected" %}
      <form action="{% url 'take_task' task.id %}" method="post" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-warning">üü° –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
      </form>
    {% endif %}

    {% if user.employee == task.assigned_employee and task.status == "sent_for_review" %}
      <form action="{% url 'take_task' task.id %}" method="post" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-warning">üü° –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </form>
    {% endif %}

    {% if user.employee == task.assigned_employee and task.task_type == "review" and task.status == "new" %}
      <form action="{% url 'task_review_take' task.id %}" method="post" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-warning">üü° –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
      </form>
    {% endif %}

    {% if user.employee == task.assigned_employee and task.status == "in_progress" and task.task_type == "regular" %}
      <a href="{% url 'task_execute' task.id %}" class="btn btn-success">‚úÖ –ò—Å–ø–æ–ª–Ω–∏—Ç—å</a>
    {% endif %}


    {% if user.employee == task.assigned_employee and task.task_type == "approval" %}
      <a href="{% url 'task_review' task.id %}" class="btn btn-success btn-sm">Plan review</a>
      <a href="{% url 'approve_plan' task.id %}" class="btn btn-success btn-sm">‚úÖ –£—Ç–≤–µ—Ä–¥–∏—Ç—å</a>
      <a href="{% url 'reject_plan' task.id %}" class="btn btn-danger btn-sm">‚ùå –í–µ—Ä–Ω—É—Ç—å –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É</a>
      <p><strong>–ò—Å–ø—Ä–∞–≤–∏—Ç—å</strong>
    {% endif %}

    {% if user.employee == task.assigned_employee and task.task_type == "review" and task.status == "in_progress" %}
      <a href="{% url 'task_review' task.id %}" class="btn btn-primary mt-2">
        üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
      </a>
    {% endif %}

    <hr>

    {% if task.status == "new" and task.task_type == "regular" and task.assigned_employee == request.user.employee %}
      <a href="#" class="btn btn-outline-primary mt-2" data-bs-toggle="modal" data-bs-target="#delegateModal">
        üîÅ –ù–∞–ø—Ä–∞–≤–∏—Ç—å
      </a>
    {% endif %}

    <a href="{% url 'task_list' %}" class="btn btn-secondary">‚¨Ö –ù–∞–∑–∞–¥</a>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="delegateModal" tabindex="-1" aria-labelledby="delegateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form action="{% url 'delegate_task' task.id %}" method="post" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="delegateModalLabel">–ù–∞–ø—Ä–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="delegate_to" class="form-label fw-bold">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</label>
          <select name="delegate_to" id="delegate_to" class="form-select" required>
            {% for emp in available_employees %}
              <option value="{{ emp.id }}">
                {{ emp.user.last_name }} {{ emp.user.first_name }} ({{ emp.position }}, {{ emp.department.name }})
              </option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<hr>
<h5>–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</h5>
<ul class="list-group mt-3">
  {% for h in task.history.all %}
    <li class="list-group-item">
      <strong>{{ h.get_action_display }}</strong>
      {% if h.employee %}
        ‚Äî {{ h.employee.user.first_name }} {{ h.employee.user.last_name }} ({{ h.employee.position }})
      {% endif %}
      <span class="text-muted float-end">{{ h.timestamp|date:"d.m.Y H:i" }}</span>
      {% if h.comment %}<br><small>{{ h.comment }}</small>{% endif %}
    </li>
  {% empty %}
    <li class="list-group-item text-muted">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞</li>
  {% endfor %}
</ul>

{% endblock %}
