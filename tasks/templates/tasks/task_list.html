{% extends "base.html" %}
{% load static %}

{% block title %}–ó–∞–¥–∞—á–∏ –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- üîπ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É -->
  {% if filter_emp %}
  <div class="alert alert-info mb-4">
    üîç –ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞–¥–∞—á–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    <strong>{{ filter_emp.user.get_full_name|default:filter_emp.user.username }}</strong>
    ({{ filter_emp.position|default:"‚Äî" }}).
    <a href="{% url 'task_list' %}" class="btn btn-sm btn-outline-secondary ms-2">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</a>
  </div>
  {% endif %}


  <!-- üî• –°—Ä–æ—á–Ω—ã–µ –∑–∞–¥–∞—á–∏ -->
    {% if urgent_tasks %}
    <div class="mb-5">
      <h4 class="fw-bold text-danger mb-3 d-flex align-items-center justify-content-between" style="cursor: pointer;"
          data-bs-toggle="collapse" data-bs-target="#urgentTasksList" aria-expanded="false">
        üî• –°—Ä–æ—á–Ω—ã–µ –∑–∞–¥–∞—á–∏ ({{ urgent_tasks|length }})
        <i class="bi bi-chevron-down small"></i>
      </h4>

      <div id="urgentTasksList" class="collapse">
        <div class="list-group shadow-sm">
          {% for task in urgent_tasks %}
          <a href="{% url 'task_detail' task.id %}"
             class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ task.title }}</strong><br>
              <small class="text-muted">
                –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ: {{ task.card.title }} |
                –î–µ–¥–ª–∞–π–Ω: {{ task.due_date|date:"d.m.Y" }} |
                –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è: {{ task.created_at|date:"d.m.Y H.i" }}
              </small>
              <small class="text-muted d-block mt-1">
                üë§ {{ task.created_by.user.last_name }} {{ task.created_by.user.first_name }}
                {% if task.created_by.position %} | {{ task.created_by.position }}{% endif %}
                {% if task.created_by.department %} | {{ task.created_by.department.shortname }}{% endif %}
              </small>
            </div>
            <span class="badge bg-danger rounded-pill">–°—Ä–æ–∫!</span>
          </a>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

<!-- ‚öôÔ∏è –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ -->
  {% if approval_tasks %}
    <div class="mb-5">
      <h4 class="fw-bold text-primary mb-3 d-flex align-items-center justify-content-between" style="cursor: pointer;"
          data-bs-toggle="collapse" data-bs-target="#approvalTasksList" aria-expanded="false">
        ‚öôÔ∏è –ó–∞–¥–∞—á–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É ({{ approval_tasks|length }})
        <i class="bi bi-chevron-down small"></i>
      </h4>

      <div id="approvalTasksList" class="collapse">
        <div class="list-group shadow-sm">
          {% for task in approval_tasks %}
          <a href="{% url 'task_detail' task.id %}"
             class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ task.title }}</strong><br>
              <small class="text-muted">
                –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ: {{ task.card.title }} |
                –î–µ–¥–ª–∞–π–Ω: {{ task.due_date|date:"d.m.Y" }} |
                –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è: {{ task.created_at|date:"d.m.Y H.i" }}
              </small>
              <small class="text-muted d-block mt-1">
                üë§ {{ task.created_by.user.last_name }} {{ task.created_by.user.first_name }}
                {% if task.created_by.position %} | {{ task.created_by.position }}{% endif %}
                {% if task.created_by.department %} | {{ task.created_by.department.shortname }}{% endif %}
              </small>
            </div>
          </a>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- ‚è≥ –í–∞—à–∏ –∑–∞–¥–∞—á–∏ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ -->
    {% if review_tasks %}
    <div class="mb-5">
      <h4 class="fw-bold text-secondary mb-3 d-flex align-items-center justify-content-between" style="cursor: pointer;"
          data-bs-toggle="collapse" data-bs-target="#reviewTasksList" aria-expanded="false">
        ‚è≥ –í–∞—à–∏ –∑–∞–¥–∞—á–∏ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ ({{ review_tasks|length }})
        <i class="bi bi-chevron-down small"></i>
      </h4>

      <div id="reviewTasksList" class="collapse">
        <div class="list-group shadow-sm">
          {% for task in review_tasks %}
          <a href="{% url 'task_detail' task.id %}"
             class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ task.title }}</strong><br>
              <small class="text-muted">
                –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ: {{ task.card.title }} |
                –î–µ–¥–ª–∞–π–Ω: {{ task.due_date|date:"d.m.Y" }} |
                –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è: {{ task.created_at|date:"d.m.Y H.i" }}
              </small>
              <small class="text-muted d-block mt-1">
                üë§ {{ task.created_by.user.last_name }} {{ task.created_by.user.first_name }}
                {% if task.created_by.position %} | {{ task.created_by.position }}{% endif %}
                {% if task.created_by.department %} | {{ task.created_by.department.shortname }}{% endif %}
              </small>
            </div>
          </a>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

        <!-- ‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è -->
    {% if rejected_tasks %}
    <div class="mb-5">
      <h4 class="fw-bold text-warning mb-3 d-flex align-items-center justify-content-between" style="cursor: pointer;"
          data-bs-toggle="collapse" data-bs-target="#rejectedTasksList" aria-expanded="false">
        ‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è ({{ rejected_tasks|length }})
        <i class="bi bi-chevron-down small"></i>
      </h4>

      <div id="rejectedTasksList" class="collapse">
        <div class="list-group shadow-sm">
          {% for task in rejected_tasks %}
          <a href="{% url 'task_detail' task.id %}"
             class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ task.title }}</strong><br>
              <small class="text-muted">
                –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ: {{ task.card.title }} |
                –î–µ–¥–ª–∞–π–Ω: {{ task.due_date|date:"d.m.Y" }} |
                –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è: {{ task.created_at|date:"d.m.Y H.i" }}
              </small>
              <small class="text-muted d-block mt-1">
                üë§ {{ task.created_by.user.last_name }} {{ task.created_by.user.first_name }}
                {% if task.created_by.position %} | {{ task.created_by.position }}{% endif %}
                {% if task.created_by.department %} | {{ task.created_by.department.shortname }}{% endif %}
              </small>
            </div>
          </a>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

  <!-- üìÖ –ö–∞—Ä—Ç–æ—á–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold">üìã –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –∑–∞–¥–∞—á–∏</h3>
    <a href="{% url 'card_create' %}" class="btn btn-success btn-sm">‚ûï –ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞</a>
  </div>

    <!-- üîπ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    {% if categories %}
    <div class="mb-4">
      <div class="d-flex flex-wrap gap-2">
        <a href="{% url 'task_list' %}"
          class="category-tab btn btn-sm {% if not active_category %}btn-primary{% else %}btn-outline-primary{% endif %}">
          üìã –í—Å–µ
          <span class="badge bg-light text-primary ms-1">{{ cards_all }}</span>
        </a>

        {% for cat in categories %}
          <a href="?category={{ cat.slug }}"
            class="category-tab btn btn-sm {% if active_category and cat.slug == active_category.slug %}btn-primary{% else %}btn-outline-primary{% endif %}">
            {{ cat.name }}
            <span class="badge bg-light text-primary ms-1">{{ cat.cards.count }}</span>
          </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  {% if cards %}
  <div class="row">
    {% for card in cards %}
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card shadow-sm h-100 border-3">
        <div class="card-body d-flex flex-column">

          <h5 class="fw-bold mb-1">
            <a href="{% url 'card_detail' card.id %}" class="text-decoration-none text-dark">
              {{ card.title }}
            </a>
          </h5>

          {% if card.categories.exists %}
            <div class="d-flex flex-wrap gap-1 mb-2">
                {% for c in card.categories.all %}
                    <span class="badge category-badge" data-category="{{ c.slug }}">{{ c.name }}</span>
                {% endfor %}
            </div>
          {% endif %}


          <p class="text-muted small mb-1">
            üìÖ {{ card.start_date|date:"d.m.Y" }} ‚Äî {{ card.end_date|date:"d.m.Y" }}
          </p>
          <p class="text-muted small mb-3">
            üè¢ {{ card.responsible_department }}
          </p>

          <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
          <div class="progress mb-3" style="height: 10px;">
            <div class="progress-bar bg-success" style="width: {{ card.progress.percent }}%;"></div>
          </div>
          <small class="text-muted mb-3">–í—ã–ø–æ–ª–Ω–µ–Ω–æ: {{ card.progress.done }}/{{ card.progress.total }}
          ({{ card.progress.percent }}%)</small>

          <!-- –°—á—ë—Ç—á–∏–∫–∏ –∑–∞–¥–∞—á -->
            <div class="d-flex gap-2 mb-3">
              {% if card.approval_count %}
                <span class="badge rounded-pill bg-primary" title="–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏">üü¶ {{ card.approval_count }}</span>
              {% endif %}
              {% if card.urgent_count %}
                <span class="badge rounded-pill bg-danger" title="–°—Ä–æ—á–Ω—ã–µ">üî¥ {{ card.urgent_count }}</span>
              {% endif %}
              {% if card.other_count %}
                <span class="badge rounded-pill bg-secondary" title="–í —Ä–∞–±–æ—Ç–µ">‚ö™ {{ card.other_count }}</span>
              {% endif %}
              {% if card.done_count %}
                <span class="badge rounded-pill bg-success" title="–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ">‚úÖ {{ card.done_count }}</span>
              {% endif %}
            </div>


          <!-- –ö–Ω–æ–ø–∫–∞ -->
          <div class="mt-auto pt-3 text-end">
            <a href="{% url 'card_detail' card.id %}" class="btn btn-outline-primary btn-sm">
              –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É ‚Üí
            </a>
          </div>

        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-secondary">
    –ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.
  </div>
  {% endif %}
</div>
{% endblock %}
