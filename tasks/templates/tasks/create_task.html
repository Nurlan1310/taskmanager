{% extends "base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-lg border-0">
    <div class="card-body p-4">
      <h4 class="fw-bold text-center mb-4">üìù –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏</h4>

      {% if card %}
      <div class="alert alert-info mb-4">
        <strong>–ö–∞—Ä—Ç–æ—á–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:</strong>
        <a href="{% url 'card_detail' card.id %}" class="fw-semibold text-decoration-none">
          {{ card.title }}
        </a>
      </div>
      {% endif %}

      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        {% if form.errors %}
        <div class="alert alert-danger">
          <strong>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã:</strong>
          <ul class="mb-0">
            {% for field, errors in form.errors.items %}
            <li><strong>{{ field|capfirst }}:</strong> {{ errors|join:", " }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <div class="mb-3">
          <label class="form-label fw-semibold">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ <span class="text-danger">*</span></label>
          {% render_field form.title class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ..." %}
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          {% render_field form.description class="form-control" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..." %}
        </div>

        <!-- –ê–¥—Ä–µ—Å–∞—Ç—ã -->
        <div class="mb-3">
          <label class="form-label fw-semibold">–ê–¥—Ä–µ—Å–∞—Ç—ã <span class="text-danger">*</span></label>
          <div id="recipients-list" class="d-flex flex-wrap gap-2 mb-2"></div>
          <button type="button" class="btn btn-outline-primary btn-sm" id="add-recipient-btn">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å–∞—Ç–∞
          </button>
          <div id="recipients-hidden-container"></div>
        </div>

        <!-- –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è -->
        <div class="mb-3">
        <label class="form-label fw-semibold">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
        {% render_field form.due_date class="form-control" type="date" %}
        </div>

        <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ Google –î–∏—Å–∫ -->
        <div class="mb-3">
        <label class="form-label fw-semibold">–°—Å—ã–ª–∫–∞ –Ω–∞ Google –î–∏—Å–∫</label>
        {% render_field form.google_drive_link class="form-control" placeholder="https://drive.google.com/..." %}
        </div>

        <!-- –í–ª–æ–∂–µ–Ω–∏–µ -->
        <div class="mb-3">
        <label class="form-label fw-semibold">–í–ª–æ–∂–µ–Ω–∏–µ (—Ñ–∞–π–ª)</label>
        {% render_field form.attachment class="form-control" %}
        </div>


        <div class="text-center mt-4">
          <button type="submit" class="btn btn-success px-4">üíæ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
          <a href="{% url 'task_list' %}" class="btn btn-outline-secondary ms-2">–ù–∞–∑–∞–¥</a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="searchModalLabel">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="searchInput" class="form-control mb-3" placeholder="–ü–æ–∏—Å–∫...">
        <ul class="list-group" id="searchResults"></ul>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const addBtn = document.getElementById("add-recipient-btn");
  const recipientsList = document.getElementById("recipients-list");
  const hiddenContainer = document.getElementById("recipients-hidden-container");
  const searchInput = document.getElementById("searchInput");
  const searchResults = document.getElementById("searchResults");
  const modalEl = document.getElementById("searchModal");

  console.log("‚úÖ JS –∑–∞–≥—Ä—É–∂–µ–Ω");

  // üîπ –ü—Ä–æ–≤–µ—Ä–∏–º employees_json
  const employees = {{ employees_json|safe }};
  console.log("üë• –°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:", employees);

  if (!window.bootstrap) {
    console.error("‚ùå Bootstrap JS –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω!");
  }

  const modal = new bootstrap.Modal(modalEl);

  addBtn.addEventListener("click", () => {
    console.log("–ö–ª–∏–∫ –ø–æ '–î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å–∞—Ç–∞'");
    searchInput.value = "";
    renderSearchResults(employees);
    modal.show();
  });

  function renderSearchResults(list) {
    searchResults.innerHTML = list.map(x => `
      <li class="list-group-item list-group-item-action" data-id="${x.id}" data-name="${x.name}">
        ${x.name}
      </li>
    `).join("");
  }

  searchInput.addEventListener("input", e => {
    const q = e.target.value.trim().toLowerCase();
    const filtered = employees.filter(x => x.name.toLowerCase().includes(q));
    renderSearchResults(filtered);
  });

  searchResults.addEventListener("click", e => {
    const li = e.target.closest("li");
    if (!li) return;
    addRecipient(li.dataset.id, li.dataset.name);
    modal.hide();
  });

  function addRecipient(id, name) {
    if ([...recipientsList.querySelectorAll("[data-id]")].some(el => el.dataset.id === id)) return;

    const badge = document.createElement("div");
    badge.className = "badge bg-primary p-2 d-flex align-items-center gap-2";
    badge.dataset.id = id;
    badge.innerHTML = `<span class="me-2">${name}</span>
      <button type="button" class="btn-close btn-close-white btn-sm" aria-label="–£–¥–∞–ª–∏—Ç—å"></button>`;
    recipientsList.appendChild(badge);

    const hidden = document.createElement("input");
    hidden.type = "hidden";
    hidden.name = "recipients";
    hidden.value = id;
    hidden.dataset.for = id;
    hiddenContainer.appendChild(hidden);

    badge.querySelector("button").addEventListener("click", () => {
      hidden.remove();
      badge.remove();
    });
  }
});
</script>
{% endblock %}
