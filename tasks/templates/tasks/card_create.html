{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-lg border-0">
        <div class="card-body p-4">

          <h4 class="fw-bold text-center mb-4">üóÇ –ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h4>

          <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}

            {% if form.errors %}
            <div class="alert alert-danger">
              <strong>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã:</strong>
              <ul class="mb-0">
                {% for field, errors in form.errors.items %}
                  <li><strong>{{ field|capfirst }}:</strong> {{ errors|join:", " }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
            <div class="mb-3">
              <label class="form-label fw-semibold">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è <span class="text-danger">*</span></label>
              {% render_field form.title class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ..." %}
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
                <div id="category-buttons" class="d-flex flex-wrap gap-2">
                  {% for cat in form.categories.field.queryset %}
                    <input type="checkbox" name="categories" value="{{ cat.id }}" id="cat-{{ cat.id }}" class="btn-check">
                    <label class="btn btn-outline-primary category-label" for="cat-{{ cat.id }}">
                      {{ cat.name }}
                    </label>
                  {% endfor %}
                </div>
            </div>


            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="mb-3">
              <label class="form-label fw-semibold">–û–ø–∏—Å–∞–Ω–∏–µ</label>
              {% render_field form.description class="form-control" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..." %}
            </div>

            <!-- –ü–ª–∞–Ω –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
            <div class="mb-3">
              <div class="form-check mb-2">
                {% render_field form.has_plan class="form-check-input" id="id_has_plan" %}
                <label for="id_has_plan" class="form-check-label fw-semibold">–° –ø–ª–∞–Ω–æ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</label>
              </div>
            </div>

            <div id="plan_section" style="display: none;">
              <div class="mb-3">
                <label class="form-label fw-semibold">üìé –ü–ª–∞–Ω –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</label>
                {% render_field form.plan_file class="form-control" %}
              </div>

              <!-- –°–æ–≥–ª–∞—Å—É—é—â–∏–µ -->
              <div class="mb-3">
                <label class="form-label fw-semibold">–°–æ–≥–ª–∞—Å—É—é—â–∏–µ (–ø–æ–æ—á–µ—Ä–µ–¥–Ω–æ)</label>
                <div id="approvers-list" class="d-flex flex-wrap gap-2 mb-2"></div>
                <button type="button" class="btn btn-outline-primary btn-sm" id="add-approver-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                <!-- –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–∫—Ä—ã—Ç—ã—Ö input'–æ–≤ -->
                <div id="approvers-hidden-container"></div>
              </div>

              <!-- –£—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π -->
              <div class="mb-3">
                <label class="form-label fw-semibold">–£—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π (–æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π)</label>
                {% render_field form.final_approver class="form-select" %}
              </div>
            </div>

            <!-- –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ -->
            <div class="mb-3">
              <label class="form-label fw-semibold">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ <span class="text-danger">*</span></label>
              {% render_field form.start_date class="form-control" type="date" %}
            </div>

            <!-- –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è -->
            <div class="mb-3">
              <label class="form-label fw-semibold">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
              {% render_field form.end_date class="form-control" type="date" %}
            </div>

            <!-- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–¥–µ–ª -->
            <div class="mb-3">
              <label class="form-label fw-semibold">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–¥–µ–ª</label>
              {% render_field form.responsible_department class="form-select" %}
            </div>

            <!-- –°–º–µ–∂–Ω—ã–µ –æ—Ç–¥–µ–ª—ã -->
            <div class="mb-3">
              <label class="form-label fw-semibold">–°–º–µ–∂–Ω—ã–µ –æ—Ç–¥–µ–ª—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
              <div id="shared-depts-list" class="d-flex flex-wrap gap-2 mb-2"></div>
              <button type="button" class="btn btn-outline-primary btn-sm" id="add-dept-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
              <div id="shared-depts-hidden-container"></div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="text-center mt-4">
              <button type="submit" class="btn btn-success px-4">
                üíæ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ
              </button>
              <a href="{% url 'task_list' %}" class="btn btn-outline-secondary ms-2">–ù–∞–∑–∞–¥</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ -->
<div class="modal fade" id="searchModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ / –æ—Ç–¥–µ–ª</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="searchInput" class="form-control mb-3" placeholder="–ü–æ–∏—Å–∫...">
        <ul class="list-group" id="searchResults"></ul>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const hasPlan = document.getElementById("id_has_plan");
  const planSection = document.getElementById("plan_section");
  const approversList = document.getElementById("approvers-list");
  const approversHiddenContainer = document.getElementById("approvers-hidden-container");
  const sharedDeptsList = document.getElementById("shared-depts-list");
  const sharedDeptsHiddenContainer = document.getElementById("shared-depts-hidden-container");

  // –¥–∞–Ω–Ω—ã–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –∏–∑ view (employees_json –∏ departments_json)
  const employees = {{ employees_json|safe }};
  const departments = {{ departments_json|safe }};

  let currentTarget = null;

  function togglePlan() {
    planSection.style.display = hasPlan.checked ? "block" : "none";
  }
  if (hasPlan) {
    hasPlan.addEventListener("change", togglePlan);
    togglePlan();
  }

  // –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
  document.getElementById("add-approver-btn").addEventListener("click", () => openSearchModal("approver"));
  document.getElementById("add-dept-btn").addEventListener("click", () => openSearchModal("dept"));

  function openSearchModal(type) {
    currentTarget = type;
    const modalEl = document.getElementById("searchModal");
    const modal = new bootstrap.Modal(modalEl);
    document.getElementById("searchInput").value = "";
    renderSearchResults(type === "approver" ? employees : departments);
    modal.show();
  }

  function renderSearchResults(list) {
    const ul = document.getElementById("searchResults");
    ul.innerHTML = list.map(x => `<li class="list-group-item list-group-item-action" data-id="${x.id}" data-name="${x.name}">${x.name}</li>`).join("");
  }

  document.getElementById("searchInput").addEventListener("input", e => {
    const q = e.target.value.trim().toLowerCase();
    const source = currentTarget === "approver" ? employees : departments;
    const filtered = source.filter(x => x.name.toLowerCase().includes(q));
    renderSearchResults(filtered);
  });

  document.getElementById("searchResults").addEventListener("click", e => {
    const li = e.target.closest("li");
    if (!li) return;
    const id = li.dataset.id;
    const name = li.dataset.name;
    addSelectedItem(currentTarget, id, name);
    bootstrap.Modal.getInstance(document.getElementById("searchModal")).hide();
  });

  function addSelectedItem(type, id, name) {
    const list = type === "approver" ? approversList : sharedDeptsList;
    const container = type === "approver" ? approversHiddenContainer : sharedDeptsHiddenContainer;
    const inputName = type === "approver" ? "approvers" : "shared_departments";

    // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥—É–±–ª–∏
    if ([...list.querySelectorAll("[data-id]")].some(el => el.dataset.id === id)) return;

    // –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å –∫—Ä–µ—Å—Ç–∏–∫–æ–º
    const badge = document.createElement("div");
    badge.className = "badge bg-primary p-2 d-flex align-items-center gap-2";
    badge.dataset.id = id;
    badge.style.marginRight = "6px";
    badge.innerHTML = `<span class="me-2">${name}</span><button type="button" class="btn-close btn-close-white btn-sm" aria-label="–£–¥–∞–ª–∏—Ç—å"></button>`;
    list.appendChild(badge);

    // —Å–∫—Ä—ã—Ç—ã–π input (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –∫–∞–∂–¥—ã–π –≤—ã–±–æ—Ä) ‚Äî Django —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç multiple inputs —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º name
    const hidden = document.createElement("input");
    hidden.type = "hidden";
    hidden.name = inputName;
    hidden.value = id;
    hidden.dataset.for = id; // –¥–ª—è —Å–≤—è–∑–∏ —Å badge
    container.appendChild(hidden);

    // —É–¥–∞–ª–µ–Ω–∏–µ
    badge.querySelector("button").addEventListener("click", () => {
      // —É–¥–∞–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π hidden
      const hid = container.querySelector(`input[data-for="${id}"]`);
      if (hid) hid.remove();
      badge.remove();
    });
  }

  // --- –ï—Å–ª–∏ —É —Ñ–æ—Ä–º—ã –µ—Å—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏),
  //     –º–æ–∂–Ω–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ approvers/shared_departments.
  //     –î–ª—è —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ HTML
  //     (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ —Ñ–æ—Ä–º—ã Django –º–æ–≥ –≤—Å—Ç–∞–≤–∏—Ç—å select). –ó–¥–µ—Å—å –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏.
});
</script>


{% endblock %}
